rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regra para a coleção 'users'
    match /users/{userId} {
      // Qualquer utilizador autenticado pode criar o seu próprio perfil.
      allow create: if request.auth != null;

      // Um utilizador só pode ler/escrever os seus próprios dados.
      // Um admin pode ler todos os utilizadores.
      allow read: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
      allow update: if request.auth.uid == userId;
      
      // Apenas um admin pode apagar utilizadores (regra a ser implementada).
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // Regra para a coleção 'discoveries'
    match /discoveries/{discoveryId} {
      // Qualquer pessoa (mesmo não autenticada) pode ler as descobertas.
      allow get, list: if true;

      // Apenas utilizadores autenticados podem criar, atualizar ou apagar as suas próprias descobertas.
      // Admins podem modificar/apagar qualquer descoberta.
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.authorId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }
    
    // Regra para a coleção 'confrarias'
    match /confrarias/{confrariaId} {
        // Leitura pública para todos
        allow get, list: if true;
        // Escrita apenas para admins (a ser implementado)
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }
  }
}